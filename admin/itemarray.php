<?php

$shopmax= array (
'Chachin' => array(5,6,7,4,5,0,4,4,5),
'Falme' => array(0,5,4,5,4,7,4,5,6),
'Tanchico' => array(5,4,6,5,0,4,7,4,5),
'Ebou Dar' => array(4,0,4,5,5,5,6,4,7),
'Illian' => array(4,4,7,4,5,6,0,5,5),
'Tear' => array(4,5,5,7,4,0,5,6,4),
'Stedding Shangtai' => array(5,4,0,5,6,7,4,5,4),
'Cairhien' => array(4,5,0,5,6,5,7,4,4),
'Tar Valon' => array(6,5,5,4,4,4,0,5,7),
'Caemlyn' => array(7,5,6,0,4,4,5,5,4),
'Far Madding' => array(5,4,5,6,7,5,4,4,0),
'Amador' => array(5,7,4,4,4,5,5,6,),
'Emond-ap-s Field' => array(0,4,5,4,7,6,5,4,5),
'Rhuidean' => array(4,0,4,7,5,4,5,5,6),
'Maradon' => array(7,4,5,6,5,5,4,0,4),
'Bandar Eban' => array(5,6,5,0,4,4,4,7,5),
'Lugard' => array(4,5,4,5,0,4,6,7,5),
'Fal Dara' => array(6,7,4,4,5,5,5,0,4),
);

$shop_base = array (
'Chachin' => array('200'=>array('0')),
'Falme' => array('500'=>array('0')),
'Tanchico' => array('600'=>array('0')),
'Ebou Dar' => array('800'=>array('0')),
'Illian' => array('200'=>array('0')),
'Tear' => array('300'=>array('0')),
'Stedding Shangtai' => array('500'=>array('0')),
'Cairhien' => array('600'=>array('0')),
'Bandar Eban' => array('700'=>array('0')),
'Tar Valon' => array('800'=>array('0')),
'Caemlyn' => array('0'=>array('0')),
'Far Madding' => array('400'=>array('0')),
'Amador' => array('100'=>array('0')),
'Emond-ap-s Field' => array('400'=>array('0')),
'Rhuidean' => array('300'=>array('0')),
'Maradon' => array('0'=>array('0')),
'Fal Dara' => array('100'=>array('0')), 
'Lugard' => array('700'=>array('0')),
);

$shop_spec = array('','2','5','6','8','2','3','5','6','7','8','0','4','1','4','3','0','1','7');

$town_consumables = array (
'Fal Dara' => array(1,4,9,3,5,8,2,6,7),
'Chachin' => array(1,5,8,2,4,9,3,6,7),
'Tar Valon' => array(1,5,9,2,6,8,3,4,7),
'Ebou Dar' => array(1,6,7,3,4,8,2,5,9),
'Falme' => array(1,6,8,2,5,7,3,4,9),
'Lugard' => array(1,6,9,3,5,7,2,4,8),
'Amador' => array(3,5,7,2,4,8,1,6,9),
'Emond-ap-s Field' => array(2,4,9,3,6,7,1,5,8),
'Stedding Shangtai' => array(2,5,7,3,4,9,1,6,8),
'Rhuidean' => array(3,4,8,2,5,9,1,6,7),
'Bandar Eban' => array(3,5,8,2,6,7,1,4,9),
'Tear' => array(2,6,8,3,4,7,1,5,9),
'Maradon' => array(3,4,7,1,5,9,2,6,8),
'Cairhien' => array(2,5,9,1,6,7,3,4,8),
'Caemlyn' => array(3,4,9,1,6,8,2,5,7),
'Tanchico' => array(2,4,8,1,6,9,3,5,7),
'Illian' => array(2,6,7,1,4,9,3,5,8),
'Far Madding' => array(3,6,7,1,5,8,2,4,9), 
);

$shopup = array (
'0' => array(2000,9000,40000,270000,675000,1300000,2200000),
'1' => array(3000,23000,111000,280000,780000,240000,3100000),
'2' => array(2500,27000,131000,333000,1070000,2130000,4000000),
'3' => array(1500,8000,32000,83000,215000,575000,731000),
'4' => array(3000,23000,118000,322000,923000,2900000,3150000),
'5' => array(2000,11000,65000,200000,455000,970000,1310000),
'6' => array(1000,11000,70000,155000,325000,532000,650000),
'7' => array(2000,22000,180000,600000,2260000,2560000),
);

$item_list = array (
'0' => array ('rags','leather armor','cloak','cadinsor','sturdy leather armor','breastplate','chain link armor',
              'warders cloak','splint mail','plate mail','myrddraal armor','royal armor','dark shroud'),
'1' => array ('short sword','sword','trolloc blade','long sword','tulwar','bastard sword','claymore','broad sword',
              'battle sword','flamberge','winged sword','dark blade','heron mark blade' ),
'2' => array ('hatchet','hand axe','trolloc axe','cleaver','half moon blade','double bladed axe','combat axe',
              'balanced axe','battle axe','bone splitter','executioner','spiked axe','great axe'),
'3' => array ('sharpened stick','iron spear','short spear','glaive','long spear','pike','javelin','lance',
              'trident','septum','black lance','combat spear','ashandarei'),
'4' => array ('sling','short bow','light crossbow','long bow','horn bow','battle bow','heavy crossbow','hunters bow',
              'long battle bow','composite crossbow','warriors bow','two rivers long bow','silver bow'),
'5' => array ('cudgel','short staff','spiked club','mallet','mace','quarter staff','flail','morning star',
              'maul','war hammer','battle staff','spiked maul','battle hammer'),
'6' => array ('stone knife','bone knife','steel bladed knife','throwing knives','belt knife','long knife','dagger',
              'long throwing knives','battle dagger','kriss','stilletto','balanced throwing knives','ruby dagger'),
'7' => array ('shield','trolloc shield','buckler','kite shield','tairen shield','defenders shield','amador shield',
              'spiked buckler','tower shield','great shield','golden shield','dark shield','dragon shield'),
'8' => array ('firespark','water spike','crush','cantrips','upheaval','lightning','tidal wave','fireball',
              'earthquake','tsunami','rend','blossoms of fire','powersurge'),
'9' => array ('broth','bread','eggs','cheese','dried beef','rabbit','fish','spiced ham','roast beef'),
'10' => array ('worrynot root','boneknit','crimsonthorn root','silver leaf','goosemint','grey fennel','dogwort',
              'greenwort','andilay root'), 
'11' => array ('oosquai','ale','blood wine','wine','cider','gara milk','tea','brandy','kaf'),             
); 

$tali_list = array (
'0' => array ('broken','worn','flawed','of beggars','of peasants','of hawkers'),
'1' => array ('slayers','nurturing','tarnished','of vermin','of thugs','of soldiers'),
'2' => array ('fine','blacksmiths','diseased','of shadows','of rot','of cutpurses'),
'3' => array ('warriors','small','large','of ogier','of strongarms','of the guard'),
'4' => array ('lucky','venomous','thiefcatchers','of the blight','of the leaf','of hunters'),
'5' => array ('killers','exceptional','master smithed','of darkfriends','of the pack','of steeds'),
'6' => array ('passive','brutal','tainted','of footpads','of serpents','of stealth'),
'7' => array ('aggressors','healing','foul','of plague','of mercenaries','of the red hand'),
'8' => array ('assassins','aiel','poisonous','of archers','of shadowspawn','of shadar logoth'),
'9' => array ('strong','power wrought','exquisite','of brigands','of commanders','of dragonsworn'),
'10' => array ('sneaky','massive','corrupt','of the green man','of the adder','of the wolf'),
'11' => array ('legendary','noble','deadly','of the stone','of the gholam','of graymen'),
'12' => array ('blessed','toxic','quick','of brawlers','of shayol ghul','of birgitte'),
'13' => array ('greedy','tinkers','sturdy','of chiefs','of avendesora','of wolfkin'),
'14' => array ('forsaken','lords','staggering','of queens','of dreadlords','of madness'),
'15' => array ('fast','jeweled','bloody','of snakes','of foxes','of the red eagle'),
'16' => array ('solid','scouts','blademasters','of kings','of the light','of the shadow'),
);

// ITEM TYPES

$item_type = array ( 
'0' => "armor",
'1' => "sword",
'2' => "axe",
'3' => "spear",
'4' => "bow",
'5' => "bludgeon",
'6' => "knife",
'7' => "shield",
'8' => "weave knowledge",
'9' => "food",
'10' => "herb",
'11' => "drink",
'12' => "talisman",
);

// ITEM BASE
/*
X- Speed
S- Stun
Y- Accuracy
V- Dodge
P- Poison
T- Taint
L- Life Gain
H- Damage to self %
G- Luck
*/

$item_base = array ( 
// armor
    'rags' => array("D2 E3 N-4",0),
    'leather armor' => array("D5 E6 N2",0),
    'cloak' => array("D9 E10 N1",0),
    'cadinsor' => array("D11 E13 V4",0),
    'sturdy leather armor' => array("D15 E18 N2",0),
    'breastplate' => array("D18 E20 V3",0),
    'chain link armor' => array("D22 E26",0),
    'warders cloak' => array("D25 E27 V2 L2 N1",0),
    'splint mail' => array("D30 E34",0),
    'plate mail' => array("D33 E37 N3",0),
    'myrddraal armor' => array("D36 E40 T2 H3",0),
    'royal armor' => array("D40 E43 G1 N2",0),
    'dark shroud' => array("D42 E46 P1 T1 G1 H1",0),

// sword
    'short sword' => array("A2 B4",1),
    'sword' => array("A6 B8",1),
    'trolloc blade' => array("A9 B11 T1",1),
    'long sword' => array("A14 B18",1),
    'tulwar' => array("A19 B23",1),
    'bastard sword' => array("A23 B27",1),
    'claymore' => array("A28 B32",1),
    'broad sword' => array("A33 B37",1),
    'battle sword' => array("A38 B42",1),
    'flamberge' => array("A43 B47",1),
    'winged sword' => array("A48 B52",1),
    'dark blade' => array("A50 B55 H6 T3",1),
    'heron mark blade' => array("A60 B60",1),
 
// axes
    'hatchet' => array("A1 B5 1",2),
    'hand axe' => array("A5 B9",2),
    'trolloc axe' => array("A9 B13 T1 O2 X-1",2),
    'cleaver' => array("A15 B20 X-1 O2",2),
    'half moon blade' => array("A20 B25 O4 X-1",2),
    'double bladed axe' => array("A25 B30 O1 X-1",2),
    'combat axe' => array("A30 B36 O1 X-1",2),
    'balanced axe' => array("A35 B42 O1 X-1",2),
    'battle axe' => array("A41 B48 X-1",2),
    'bone splitter' => array("A46 B54 X-1",2),
    'executioner' => array("A51 B60 X-1",2),
    'spiked axe' => array("A52 B61 O1 T2 X-1",2),
    'great axe' => array("A61 B71 O1 X-1",2),
    
// spears
    'sharpened stick' => array("A2 B4 V1",3),
    'iron spear' => array("A5 B8 V4",3),
    'short spear' => array("A10 B12 V5",3),
    'glaive' => array("A14 B16 V4",3),
    'long spear' => array("A17 B21 V6",3),
    'pike' => array("A21 B25 V5",3),
    'javelin' => array("A26 B30 V4",3),
    'lance' => array("A30 B36 V4 N-1",3),
    'trident' => array("A36 B40 V3",3),
    'septum' => array("A40 B44 V4",3),
    'black lance' => array("A41 B46 T2 V3",3),
    'combat spear' => array("A47 B53 V4 O3",3),
    'ashandarei' => array("A51 B57 V4 O4",3),

// bows
    'sling' => array("A2 B4 Y1",4),
    'short bow' => array("A5 B8 Y4",4),
    'light crossbow' => array("A9 B12 Y6 O4",4),
    'long bow' => array("A14 B16 Y4",4),
    'horn bow' => array("A17 B21 Y3 V3",4),
    'battle bow' => array("A21 B25 Y5",4),
    'heavy crossbow' => array("A25 B29 O4 Y4",4),
    'hunters bow' => array("A30 B36 Y4 N-1",4),
    'long battle bow' => array("A35 B39 N3 Y3",4),
    'composite crossbow' => array("A39 B44 Y2 O5",4),
    'warriors bow' => array("A44 B49 Y2 O4",4),
    'two rivers long bow' => array("A47 B53 Y4 O3",4),
    'silver bow' => array("A52 B56 Y4 O4",4),

// bludgeon
    'cudgel' => array("A3 B3",5),
    'short staff' => array("A6 B7 N2 S1",5),
    'spiked club' => array("A10 B12 N4 S1",5),
    'mallet' => array("A13 B16 S2",5),
    'mace' => array("A17 B20 S2 N3",5),
    'quarter staff' => array("A21 B24 S1 N6",5),
    'flail' => array("A26 B29 S1 N4",5),
    'morning star' => array("A29 B33 S2 N3",5),
    'maul' => array("A34 B38 S1 N6",5),
    'war hammer' => array("A39 B43 S1 Y2 N1",5),
    'battle staff' => array("A43 B48 S2",5),
    'spiked maul' => array("A48 B52 S2",5),
    'battle hammer' => array("A53 B57 S1 Y4 N-3",5),

// knives
    'stone knife' => array("A1 B3",6),
    'bone knife' => array("A3 B6 O4",6),
    'steel bladed knife' => array("A7 B9",6),
    'throwing knives' => array("A9 B11 Y3 O1",6),
    'belt knife' => array("A12 B14 O3",6),
    'long knife' => array("A15 B17 O4",6),
    'dagger' => array("A19 B21",6),
    'long throwing knives' => array("A21 B23 Y3 O1",6),
    'battle dagger' => array("A23 B27 O7",6),
    'kriss' => array("A28 B32",6),
    'stilletto' => array("A31 B33 O4",6),
    'balanced throwing knives' => array("A33 B36 Y3 O1",6),
    'ruby dagger' => array("A34 B39 T3 H6",6),
    
// shields
    'shield' => array("D1 E2 N3",7),
    'trolloc shield' => array("D2 E5 O5",7),
    'buckler' => array("D5 E7 V4",7),
    'kite shield' => array("D7 E10",7),
    'tairen shield' => array("D9 E12 Y1",7),
    'defenders shield' => array("D12 E14 N1 V1",7),
    'amador shield' => array("D15 E17",7),
    'spiked buckler' => array("D17 E19 O4",7),
    'tower shield' => array("D19 E22 N4",7),
    'great shield' => array("D23 E25",7),
    'golden shield' => array("D24 E27 L3",7),
    'dark shield' => array("D26 E30 T2 H6",7),
    'dragon shield' => array("D28 E30 A1 B1 O1 N1 V1 Y1 L1",7),

// weaves
    'firespark' => array("mA35 fA25 sB10 sO5 sU1",8,464),
    'water spike' => array("mA25 fA35 sB11 sN5",8,464),
    'crush' => array("mA30 fA40 sB12 sY8",8,3200),
    'cantrips' => array("mA40 fA30 sB9 sV8",8,3200),
    'upheaval' => array("mA45 fA35 sB8 sG10 sU1",8,8528),
    'lightning' => array("mA35 fA45 sB13 sV20 sY20 sU1",8,8528),
    'tidal wave' => array("mA40 fA50 sB10 sN6 sU1",8,17000),
    'fireball'=> array("mA50 fA40 sB11 sO6 sU1",8,17000),
    'earthquake' => array("mA55 fA45 sB7 sS15 sU1",8,29000),
    'tsunami'=> array("mA45 fA55 sB15 sV6 sU1",8,29000),
    'rend' => array("mA50 fA60 sB12 sX20 sU1",8,44200),
    'blossoms of fire' => array("mA60 fA50 sB10 sY6 sU1",8,44200),
    'powersurge' => array("mA65 fA65 sB10 sU1",8,57600),
    
// food
    'broth' => array("M2",9,20),
    'bread' => array("M4",9,40),
    'eggs' => array("M6",9,60),
    'cheese' => array("M8",9,80),
    'dried beef' => array("M10",9,100),
    'rabbit' => array("M12",9,120),
    'fish' => array("M14",9,140),
    'spiced ham' => array("M16",9,160),
    'roast beef' => array("M18",9,180),

// herb
    'worrynot root' => array("O4",10,100),
    'boneknit' => array("N4",10,100),
    'crimsonthorn root' => array("T2",10,200),
    'silver leaf' => array("Y2",10,100),
    'goosemint' => array("V2",10,100),
    'grey fennel' => array("P2",10,200),
    'dogwort' => array("L2",10,100),
    'greenwort' => array("S1",10,200),
    'andilay root' => array("X1",10,300),  

// drink
    'oosquai' => array("O8 Y-3",11,100),
    'ale' => array("N8 O-6",11,100),
    'blood wine' => array("T4 N-6",11,200),
    'wine' => array("Y4 V-3",11,100),
    'cider' => array("V4 O-6",11,100),
    'gara milk' => array("P4 X-1",11,200),
    'tea' => array("L4 Y-3",11,100),
    'brandy' => array("S3 V-5",11,200),
    'kaf' => array("X2 O-12",11,300),

// talisman
    'talisman' => array("A0 B0",12),
);
// TALISMAN MUST BE LAST ITEM FOR SHOP CODE TO WORK CORRECTLY

$some_prefixes = array('','sturdy','enhanced','light','large','small','cheap','hawkers','flawed','tarnished','weak','master smithed','ancient','dark','tainted');


$item_ix = array(

// crap
'broken' => "O-15",
'flawed' => "N-10",
'worn' => "O-5",
'of beggars' => "N-15",
'of peasants' => "O-10",
'of hawkers' => "N-5",

// taint
'tarnished' =>"T2",
'tainted' => "T6",
'corrupt' => "T10",
'of the blight' => "T4",
'of shadar logoth' => "T8",
'of shayol ghul' => "T12",

// poison
'venomous' => "P4",
'poisonous' => "P8",
'toxic' => "P12",
'of vermin' => "P2",
'of serpents' => "P6",
'of the adder' => "P10",

// poison and taint
'diseased' => "P1 T2",
'foul' => "P2 T4",
'deadly' => "P3 T6",
'of rot' => "P2 T1",
'of plague' => "P4 T2",
'of graymen' => "P6 T3",

// gold
'lucky' => "G4",
'sneaky' => "G8",
'greedy' => "G12",
'of cutpurses' => "G2",
'of footpads' => "G6",
'of brigands' => "G10",

// life gain
'nurturing' => "L2",
'healing' => "L6",
'blessed' => "L10",
'of the leaf' => "L4",
'of the green man' => "L8",
'of avendesora' => "L12",

// speed
'small' => "X1 O-10",
'quick' => "X2",
'fast' => "X3 O-10",
'of steeds' => "X1",
'of the wolf' => "X2 O-10",
'of foxes' => "X3",

// stun
'large' => "S1 O-5",
'massive' => "S2 O-5",
'staggering' => "S3 O-5",
'of the pack' => "S1",
'of brawlers' => "S2",
'of snakes' => "S3",

// accuracy
'slayers' => "Y1",
'brutal' => "Y3",
'legendary' => "Y5",
'of hunters' => "Y2",
'of archers' => "Y4",
'of birgitte' => "Y6",

// dodge
'thiefcatchers' => "V2",
'aiel' => "V4",
'tinkers' => "V6",
'of shadows' => "V1",
'of stealth' => "V3",
'of the gholam' => "V5",

// attack
'fine' => "A3 B5",
'exceptional' => "A7 B9",
'exquisite' => "A11 B13",
'of thugs' => "A1 B3",
'of strongarms' => "A5 B7",
'of mercenaries' => "A9 B11",

'warriors' => "O4",
'noble' => "O12",
'lords' => "O20",
'of commanders' => "O8",
'of chiefs' => "O16",
'of kings' => "O24",

// defense
'blacksmiths' => "D3 E5",
'master smithed' => "D7 E9",
'power wrought' => "D11 E13",
'of soldiers' => "D1 E3",
'of the guard' => "D5 E7",
'of the red hand' => "D9 E11",

'strong' => "N8",
'sturdy' => "N16",
'solid' => "N24",
'of ogier' => "N4",
'of the stone' => "N12",
'of queens' => "N20",

// general
'killers' => "A2 B4 P2",
'assassins' => "A4 B6 P4",
'forsaken' => "A6 B8 P6",
'of darkfriends' => "A2 B4 T2",
'of shadowspawn' => "A4 B6 T4",
'of dreadlords' => "A6 B8 T6",

'aggressors' => "O10 N-10",
'passive' => "O-10 N10",
'bloody' => "L10 H10",
'of dragonsworn' => "O5 N5",
'of wolfkin' => "O10 N10",
'of the red eagle' => "O15 N15",

'jeweled' => "G20 N-5 O-5",
'scouts' => "X3 V3 N5",
'blademasters' => "S6 Y3 O5",
'of madness' => "H30 O30",
'of the light' => "D5 E10 N10 L10",
'of the shadow' => "A5 B10 O10 P8",
);

// ITEM NAME GENERATOR FUNCTION

function iname($item,$itmlist)
{
$name = ucwords($itmlist[$item][1]);
if ($name) $name .= " ";
$name .= ucwords($itmlist[$item][0]);
if ($itmlist[$item][2]) $name .= " ".str_replace("Of","of",ucwords($itmlist[$item][2]));
return $name;
}

// PARSER FUNCTION

function cparse($string,$resolve)
{
  // RESOLVE all common terms and place in array
  $resolve = explode(" ",$string);
  for ($x=0; $x<count($resolve); $x++)
  {

    if (!preg_match('/^[a-z]*$/i',$resolve[$x][0].$resolve[$x][1])) // one letter code
    {
      $array[$resolve[$x][0]] += intval($resolve[$x][1].$resolve[$x][2].$resolve[$x][3].$resolve[$x][4].$resolve[$x][5]);  
    }
    else // two letter code
    {
      $array[$resolve[$x][0].$resolve[$x][1]] += intval($resolve[$x][2].$resolve[$x][3].$resolve[$x][4].$resolve[$x][5].$resolve[$x][6]);  
    }
  }
  if ($array['P']>100) $array['P']=100;
  if ($array['C']>95) $array['C']=95;
  return $array;
}

// ITEM STRING REDUCER FUNCTION
/*
X- Speed
S- Stun
Y- Accuracy
V- Dodge
P- Poison
T- Taint
L- Life Gain
H- Damage to self %
G- Luck
*/
function itp($string,$type)
{
$array = cparse($string,0);
// Handle item parsing
/*
if ($array[A]) $string .= " A".(-$array[A]);
if ($array[B]) $string .= " B".(-$array[B]);
if ($array[O]) $string .= " O".(-$array[O]);
if ($array[D]) $string .= " D".(-$array[D]);
if ($array[E]) $string .= " E".(-$array[E]);
if ($array[N]) $string .= " N".(-$array[N]);
if ($array[P]) $string .= " P".(-$array[P]);
if ($array[T]) $string .= " T".(-$array[T]);
if ($array[X]) $string .= " X".(-$array[X]);
if ($array[S]) $string .= " S".(-$array[S]);
if ($array[Y]) $string .= " Y".(-$array[Y]);
if ($array[V]) $string .= " V".(-$array[V]);
if ($array[L]) $string .= " L".(-$array[L]);
if ($array[H]) $string .= " H".(-$array[H]);
if ($array[G]) $string .= " G".(-$array[G]);
if ($array[sC]) $string .= " sC".(-$array[sC]);
if ($array[xC]) $string .= " xC".(-$array[xC]);
if ($array[pC]) $string .= " pC".(-$array[pC]);
if ($array[oC]) $string .= " oC".(-$array[oC]);
if ($array[bC]) $string .= " bC".(-$array[bC]);
if ($array[kC]) $string .= " kC".(-$array[kC]);
if ($array[hC]) $string .= " hC".(-$array[hC]);
if ($array[wC]) $string .= " wC".(-$array[wC]);
if ($array[rC]) $string .= " rC".(-$array[rC]);
*/
return $string;
}

// COMBINE LIKE BATTLE COMMANDS

function clbc($string)
{
$array = cparse($string,0);
$return_string = "";
foreach ($array as $x => $y)
{
$return_string .= $x.$y." ";
}
return $return_string;
}

// LEVEL TO WORTH CONVERTER

function lvl2worth($lvl)
{
return intval($lvl+10/9*pow($lvl*0.9,3)+100);
}

// LINEAR TO EXP HEALTH

function lin2exp_hp($lvl)
{
return intval(pow($lvl,1.35)*1.5+19 + pow($lvl-1,1.08));
}

// ITEM INFO

function show_sign1($thing) {
if ($thing < 0) return $thing; else return "+".$thing;
}

function itm_info($char_stats)
{
  $item_type = array ('0' => "Armor",'1' => "Swords",'2' => "Axes",'3' => "Spears",'4' => "Bows",'5' => "Bludgeons",'6' => "Knives",'7' => "Shields",'8' => "Weaves",);

  $bonus="";
  if ($char_stats['W']) $bonus .= $item_type[$char_stats['W']]." only<br>";
  if ($char_stats['A'] < 0) $char_stats['A'] = 0;
  if ($char_stats['B'] < $char_stats['A']) $char_stats['B'] = $char_stats['A'];
  if ($char_stats['D'] < 0) $char_stats['D'] = 0;
  if ($char_stats['E'] < $char_stats['D']) $char_stats['E'] = $char_stats['D'];
  
  if ($char_stats['A'] || $char_stats['B']) $bonus .= $char_stats['A']."-".$char_stats['B']." dmg<br>";
  if ($char_stats['F']) $bonus .= show_sign1($char_stats['F'])." fire dmg<br>";
  if ($char_stats['D'] || $char_stats['E']) $bonus .= $char_stats['D']."-".$char_stats['E']." block<br>";
  if ($char_stats['O']) $bonus .= show_sign1($char_stats['O'])."% dmg<br>";
  if ($char_stats['N']) $bonus .= show_sign1($char_stats['N'])."% def<br>";
  if ($char_stats['H']) $bonus .= $char_stats['H']."% dmg to self<br>";
  if ($char_stats['L']) $bonus .= $char_stats['L']."% health gain<br>";
  if ($char_stats['G']) $bonus .= show_sign1($char_stats['G'])." Luck<br>";
  if ($char_stats['P']) $bonus .= $char_stats['P']."% poison dmg<br>";
  if ($char_stats['T']) $bonus .= show_sign1($char_stats['T'])." taint dmg<br>";
  if ($char_stats['X']) $bonus .= show_sign1($char_stats['X'])." speed<br>";
  if ($char_stats['S']) $bonus .= show_sign1($char_stats['S'])." stun<br>";
  if ($char_stats['Y']) $bonus .= show_sign1($char_stats['Y'])." accuracy<br>";
  if ($char_stats['V']) $bonus .= show_sign1($char_stats['V'])." dodge<br>"; 
  if ($char_stats['M']) $bonus .= show_sign1($char_stats['M'])." stamina<br>"; 
  if ($char_stats['sC']) $bonus .= show_sign1($char_stats['sC'])."% sword usage cost<br>";
  if ($char_stats['xC']) $bonus .= show_sign1($char_stats['xC'])."% axe usage cost<br>";
  if ($char_stats['pC']) $bonus .= show_sign1($char_stats['pC'])."% spear usage cost<br>";
  if ($char_stats['oC']) $bonus .= show_sign1($char_stats['oC'])."% bow usage cost<br>";
  if ($char_stats['bC']) $bonus .= show_sign1($char_stats['bC'])."% bludgeon usage cost<br>";
  if ($char_stats['kC']) $bonus .= show_sign1($char_stats['kC'])."% knife usage cost<br>";
  if ($char_stats['hC']) $bonus .= show_sign1($char_stats['hC'])."% shield usage cost<br>";
  if ($char_stats['wC']) $bonus .= show_sign1($char_stats['wC'])."% weave usage cost<br>";
  if ($char_stats['rC']) $bonus .= show_sign1($char_stats['rC'])."% armor usage cost<br>";


  return str_replace(" ", "&nbsp;", $bonus);
}

// ITEM COMPONENTS

function add_bigarrays($array1,$array2) {
  for ($x=0; $x<count($array1); $x++)
    for ($y=0; $y<count($array1[0]); $y++)
      $array1[$x][$y]=intval($array1[$x][$y])+intval($array2[$x][$y]);
  return $array1;
}

function add_bigarrays20($array1,$array2) {
  for ($x=0; $x<count($array1); $x++)
    for ($y=0; $y<count($array1[0]); $y++) {
      $array1[$x][$y]=intval($array1[$x][$y])+intval($array2[$x][$y]);
      if ($array1[$x][$y] > 20) $array1[$x][$y] = 20;
    }
  return $array1;
}

function add_arrays($array1,$array2) {
  for ($x=0; $x<count($array1); $x++) $array1[$x]=intval($array1[$x])+intval($array2[$x]);
  return $array1;
}

function itm_req($string) {
  $char_stats = cparse($string,0);
  
  // BASE REQUIREMENTS (Wood, Furs, Ores)
  $types = array(
    array(array(0.8,0.8,1,0.3),array(2,1.8,2,1.2),array(0.9,1,0.8,0.6)),
    array(array(0.8,1,0.7,0),array(0,0,0,0),array(4,3.5,3,1.2)),
    array(array(1,0.85,0.7,.4),array(0,0,0,0),array(3,2.4,0.8,0.4)),
    array(array(3.5,3,3.3,1.1),array(0,0,0,0),array(0.5,0.6,0.7,0.8)),
    array(array(4,3.8,3.2,1),array(0,0,0,0),array(0.8,0.8,1,0)),
    array(array(2,1.6,1.8,0.6),array(0,0,0,0),array(2,1.6,1.8,0.6)),
    array(array(1.3,0.9,1,0),array(0,0,0,0),array(3,2.6,3,1.3)),
    array(array(1,1.1,0.8,0.4),array(2,2.2,1.9,1),array(1,1.1,0.8,0.4)),
  );
  $types_s = array(
    array(array(2,2.5,2.1,1),array(0,0,0,0),array(0,0,0,0)),
    array(array(0,0,0,0),array(2,2,2.5,1.1),array(0,0,0,0)),
    array(array(0,0,0,0),array(0,0,0,0),array(2,1.8,2,1)),
    array(array(1,1.2,1,0.6),array(2,2,1.3,1),array(2,2,1.3,1)),
  );
  $supplies = $types[intval($char_stats['wT'])];
  $supplies_s = $types[intval($char_stats['sT'])];
  if (!$char_stats['sL']) $supplies_s=array(array(0,0,0,0),array(0,0,0,0),array(0,0,0,0));
  if (!$char_stats['wL']) $supplies=array(array(0,0,0,0),array(0,0,0,0),array(0,0,0,0));
  for ($x=0; $x<3; $x++) {
    for ($y=0; $y<4; $y++) {
      $supplies[$x][$y] = intval($supplies[$x][$y]*$char_stats['wL']/10)+intval($supplies_s[$x][$y]*$char_stats['sL']/10);
      $supplies[$x][$y] -= $y*3;
      if ($supplies[$x][$y]<0) $supplies[$x][$y] = 0;
      if ($supplies[$x][$y]>20) $supplies[$x][$y] = 20;
    }
  }
  return $supplies;
}

function itm_req_list($string) {
  $supplies = itm_req($string);
  $text = '';
  for ($x=0; $x<3; $x++) {
    for ($y=0; $y<4; $y++) {
      $text .= intval($supplies[$x][$y]).",";
    }
  }
  $text = substr_replace($text,"",-1);
  return $text;
}

// ITEM VALUE PRODUCER

function item_val($string) 
{
  $worth = round(pow(lvl_req($string,100),2)/3);

  if ($worth < 0) $worth = 0;
  return $worth;
}

function lvl_req_v2($string) {
  $char_stats = cparse($string,0);
  $lvl = round(((($char_stats['X']+($char_stats['S']/2))/10)+1)*((((($char_stats['L']*8/5)+($char_stats['P']*2))/100)+1)*((((($char_stats['O']+$char_stats['N']-$char_stats['H'])+(($char_stats['V']+$char_stats['Y'])*1.75))/100)+1)*((($char_stats['A']+$char_stats['B'])/2 + ($char_stats['D']+$char_stats['E'])*3/4 + $char_stats['P']*2+ $char_stats['T']*2 + $char_stats['G']*2)*6))));
  return $lvl < 1 ? 1 : $lvl;
}

function lvl_req($string, $mod) {
  $char_stats = cparse($string,0);
  $lvl = round(((($char_stats['X']+($char_stats['S']/2))/10)+1)*((((($char_stats['L']*8/5)+$char_stats['P'])/100)+1)*((((($char_stats['O']+$char_stats['N']-$char_stats['H'])+(($char_stats['V']+$char_stats['Y'])*1.75))/100)+1)*((($char_stats['A']+$char_stats['B'])/2 + ($char_stats['D']+$char_stats['E'])*5/8 + $char_stats['P']+ $char_stats['T']*2 + $char_stats['G']*2)*6)))  );
  if ($char_stats['mA']) $lvl += round((($char_stats['mA']+$char_stats['fA']+abs($char_stats['mA']-$char_stats['fA'])-10)/10-5)*60-30);
  $lvl = round(($lvl * $mod)/100);
  return $lvl < 1 ? 1 : $lvl;
}

function old_lvl_req($string) {
  $char_stats = cparse($string,0);
  $lvl = round(pow(($char_stats['wL']+$char_stats['sL'])/10,1.2)*1.8);
  return $lvl < 1 ? 1 : $lvl;
}

function item_val_old($string)
{
  $array = cparse($string,0);

  $damage = 0.45*($array[A] + $array[B] + $array[rA] + $array[rB] + $array[oA] + $array[oB] + $array[D] + $array[E] + $array[rD] + $array[rE] + $array[oD] + $array[oE]);

  $percent = 3*$array[P] + $array[N] + $array[rN] + $array[oN] + $array[O] + $array[rO] + $array[oO] + 2*$array[C] + 2.5*$array[G] - 1.5*$array[H] + 15*$array[S] + 15*$array[U];

  if ($damage) $damage = $damage*(100+$percent)/100;
  elseif ($percent) $damage = 50*(100+$percent)/100;
  $damage += 2.5*$array[T];

  $worth = intval(($damage + ((1/9)*$damage*$damage*$damage ))*10);

  if ($worth > 10000) $worth = intval(($worth/100)+0.5)*100;
  if ($worth < 1) $worth = 1;
  return $worth;
}

function sortItems($itmlist, $sortBy, $base=0, $ix=0, $skills='')
{
  $listsize = count($itmlist);

// name
  if ($sortBy == 0)
  {
    for ($itmnew = 0; $itmnew < $listsize; $itmnew++)
    {
      $tmp = 0;
      for ($itm = 1; $itm < count($itmlist); $itm++)
      {
        $first_i = 0;
        $first_t = 0;
        if ($itmlist[$itm][1] != "") $first_i = 1;
        if ($itmlist[$tmp][1] != "") $first_t = 1;        
        if ($itmlist[$itm][$first_i] < $itmlist[$tmp][$first_t]) $tmp = $itm;
        elseif ($itmlist[$itm][$first_i] == $itmlist[$tmp][$first_t])
        {
          $second_i=2;
          $second_t=2;
          if ($itmlist[$itm][1] != "") $second_i = 0;
          if ($itmlist[$tmp][1] != "") $second_t = 0;        
          if ($itmlist[$itm][$second_i] < $itmlist[$tmp][$second_t]) $tmp = $itm;
          elseif ($itmlist[$itm][$second_i] == $itmlist[$tmp][$second_t])
          {
            if ($itmlist[$itm][2] < $itmlist[$tmp][2]) $tmp = $itm;        
          }
        }
      }
      $newlist[$itmnew] = $itmlist[$tmp];
      $y = $tmp;
      while ($y < count($itmlist) - 1)
      {
        $itmlist[$y] = $itmlist[$y+1];
        $y++;
      }
      array_pop($itmlist);
    }
    $itmlist = $newlist;
  }
// type
  elseif ($sortBy==1)
  {
    for ($itmnew = 0; $itmnew < $listsize; $itmnew++)
    {
      $tmp = 0;
      for ($itm = 1; $itm < count($itmlist); $itm++)
      {
        if ($base[$itmlist[$itm][0]][1] < $base[$itmlist[$tmp][0]][1]) $tmp = $itm;
      }
      $newlist[$itmnew] = $itmlist[$tmp];
      $y = $tmp;
      while ($y < count($itmlist) - 1)
      {
        $itmlist[$y] = $itmlist[$y+1];
        $y++;
      }
      array_pop($itmlist);
    }
    $itmlist = $newlist;      
  }
// points  
  elseif ($sortBy==2)
  {
    for ($itmnew = 0; $itmnew < $listsize; $itmnew++)
    {
      $tmp = 0;
      for ($itm = 1; $itm < count($itmlist); $itm++)
      {
        if (lvl_req($base[$itmlist[$itm][0]][0]." ".$ix[$itmlist[$itm][2]]." ".$ix[$itmlist[$itm][1]],getTypeMod($skills,$base[$itmlist[$itm][0]][1])) < lvl_req($base[$itmlist[$tmp][0]][0]." ".$ix[$itmlist[$tmp][2]]." ".$ix[$itmlist[$tmp][1]],getTypeMod($skills,$base[$itmlist[$tmp][0]][1]))) $tmp = $itm;
      }
      $newlist[$itmnew] = $itmlist[$tmp];
      $y = $tmp;
      while ($y < count($itmlist) - 1)
      {
        $itmlist[$y] = $itmlist[$y+1];
        $y++;
      }
      array_pop($itmlist);
    }
    $itmlist = $newlist; 
  }
// cached
  elseif ($sortBy==3)
  {
    for ($itmnew = 0; $itmnew < $listsize; $itmnew++)
    {
      $tmp = 0;
      for ($itm = 1; $itm < count($itmlist); $itm++)
      {
        if ($itmlist[$itm][3] < $itmlist[$tmp][3]) $tmp = $itm;      
      }
      $newlist[$itmnew] = $itmlist[$tmp];
      $y = $tmp;
      while ($y < count($itmlist) - 1)
      {
        $itmlist[$y] = $itmlist[$y+1];
        $y++;
      }
      array_pop($itmlist);
    }
    $itmlist = $newlist;      
  }
// location (vaults only)
  elseif ($sortBy==4)
  {
    for ($itmnew = 0; $itmnew < $listsize; $itmnew++)
    {
      $tmp = 0;
      for ($itm = 1; $itm < count($itmlist); $itm++)
      {
        if ($itmlist[$itm][4] < $itmlist[$tmp][4]) $tmp = $itm;      
      }
      $newlist[$itmnew] = $itmlist[$tmp];
      $y = $tmp;
      while ($y < count($itmlist) - 1)
      {
        $itmlist[$y] = $itmlist[$y+1];
        $y++;
      }
      array_pop($itmlist);
    }
    $itmlist = $newlist;
  }
// worth  
  elseif ($sortBy==5)
  {
    for ($itmnew = 0; $itmnew < $listsize; $itmnew++)
    {
      $tmp = 0;
      for ($itm = 1; $itm < count($itmlist); $itm++)
      {
        if (lvl_req($base[$itmlist[$itm][0]][0]." ".$ix[$itmlist[$itm][2]]." ".$ix[$itmlist[$itm][1]],100) < lvl_req($base[$itmlist[$tmp][0]][0]." ".$ix[$itmlist[$tmp][2]]." ".$ix[$itmlist[$tmp][1]],100)) $tmp = $itm;
      }
      $newlist[$itmnew] = $itmlist[$tmp];
      $y = $tmp;
      while ($y < count($itmlist) - 1)
      {
        $itmlist[$y] = $itmlist[$y+1];
        $y++;
      }
      array_pop($itmlist);
    }
    $itmlist = $newlist; 
  }
  return $itmlist;
}

function show_quest_reqs($reqs_stats)
{
  $class_type = array ('1' => "Warrior",'10' => "Woodsman",'20' => "Aiel",'30' => "Channeler",'40' => "Ogier",'50' => "Shadowspawn",);

  $reqs="";
  if ($reqs_stats['L']) $reqs .= "Level ".$reqs_stats['L']."<br>";
  if ($reqs_stats['C']) $reqs .= $class_type[$reqs_stats['C']]."-based class<br>";
  if ($reqs_stats['S']==1) $reqs .= "Male<br>"; elseif ($reqs_stats['S']==2) $reqs .= "Female<br>";
  
  return str_replace(" ", "&nbsp;", $reqs);
}

function check_quest_reqs($reqs_stats, $char)
{
  $class_type = array ('1' => "Warrior",'10' => "Woodsman",'20' => "Aiel",'30' => "Channeler",'40' => "Ogier",'50' => "Shadowspawn",);

  $reqs_met = 1;
  if ($reqs_stats['L'] && $reqs_stats['L'] > $char[level])
  { $reqs_met = 0; }
  if ($reqs_stats['C']) 
  {
    if ($reqs_stats['C'] == 1 || $reqs_stats['C']%10 == 0) // generic class
    {
      if (floor($reqs_stats['C']/10) != floor($char[type]/10))
      { $reqs_met = 0; }
    }
    else if (floor($reqs_stats['C']/2) != floor($char[type]/2)) // specific class
    { $reqs_met = 0; }
  }
  if (($reqs_stats['S']==1 && $char[sex] != 0) || ($reqs_stats['S']==2 && $char[sex] != 1))
  { $reqs_met = 0; }
  
  return $reqs_met;
}

function show_quest_goals($item_base, $enemy_list, $cge, $goals, $type)
{
  $rval = "";
  if ($type == 0)
  {
    $itm = $goals[1];
    $itm_name= "";
    if ($itm[1] != "" && $itm[1] != "*")
    {
      $itm_name .= $itm[1]." ";
    }
    if ($itm[0] != "" && $itm[0] != "*")
    {
      $itm_name .= $itm[0]." ";
    }
    else $itm_name .= "Item ";
    if ($itm[2] != "" && $itm[2] != "*")
    {
      $itm_name .= $itm[2]." ";
    }
    $itm_name = ucwords($itm_name);

    if ($item_base[$itm[0]][1] <9 || $item_base[$itm[0]][1] == 12)
    {
      if ($itm[1] == "*" && $itm[2] == "*") $itm_name .= "(Any prefix or suffix) ";
      elseif ($itm[1] == "*") $itm_name .= "(Any prefix) ";
      elseif ($itm[2] == "*") $itm_name .= "(Any suffix) ";
    }
    
    $rval = "Take ".$goals[0]." ".$itm_name."to ".$goals[2];
  }
  elseif ($type == 1)  
  {
    $ename = $enemy_list[$goals[2]][$goals[1]][$cge];
    $rval = "Defeat any ".$ename." in ".str_replace("-ap-", "'", str_replace("_", " ", $goals[2]))." ".$goals[0]." times";
  }
  elseif ($type == 2)
  {
    $rval = "Defeat ".str_replace("_", " ", $goals[1])." ".$goals[0]." times";
  }
  elseif ($type == 3) 
  {
    $rval = "Defeat members of ".$goals[1]." ".$goals[0]." times";
  }

  return $rval;
}

function check_inventory_items ($item, $inventory)
{
  $count = 0;
  $itm = unserialize($item);
  $inv = unserialize($inventory);
  
  for ($i=0; $i < count($inv); ++$i)
  {
    $found = 1;
    if ($inv[$i][3] <= 0)
    {
      if ($itm[0] != '*')
      {
        if (strtolower($inv[$i][0]) != strtolower($itm[0])) $found=0;
      }
      if ($found && $itm[1] != '*')
      {
        if (strtolower($inv[$i][1]) != strtolower($itm[1])) $found=0;
      }
      if ($found && $itm[2] != '*')
      {
        if (strtolower($inv[$i][2]) != strtolower($itm[2])) $found=0;    
      }  
    }
    else $found = 0;
    if ($found) $count++;        
  }
  
  return $count;
}

function take_quest_items ($goal, $inventory)
{
  $goals = unserialize($goal);
  $itm = ($goals[1]);
  $inv = unserialize($inventory);
  
  $count = 0;
  $listsize = count($inv);
  for ($i=0; $i < $listsize; ++$i)
  {
    $found = 1;
    if ($inv[$i][3] <= 0)
    {
      if ($itm[0] != '*')
      {
        if (strtolower($inv[$i][0]) != strtolower($itm[0])) $found=0;
      }
      if ($found && $itm[1] != '*')
      {
        if (strtolower($inv[$i][1]) != strtolower($itm[1])) $found=0;
      }
      if ($found && $itm[2] != '*')
      {
        if (strtolower($inv[$i][2]) != strtolower($itm[2])) $found=0;    
      }  
    }
    else $found = 0;
    if ($found && $count < $goals[0])
    {
      $y = $i;
      while ($y < $listsize)
      {
        if ( $listsize - 1 > $y ) $inv[$y] = $inv[$y+1];
        $y++;
      }
      $listsize = $listsize - 1;
      array_pop($inv);
      $i--;
      $count++;
    }        
  }
  
  $rval = serialize($inv);
  return $rval;
}

// $users - array of all characters currently in quest town
// $loc = location
function generate_random_quest($item_base, $users, $loc)
{
  $type = intval(rand(0,1));
  $started = time()/3600;
  $expire = $started + 12*intval(rand(3,6));
  $num_avail = -1;
  $num_done = 0;
  
  if ($type == 0)
  {
    $goals[0] = intval(rand(1,5));
    
    $lvltot = 0;
    $lvl = 1;
    for ($i = 0; $i < count($users); $i++)
    {
      $char = $users[$i];
      $lvltot += $char[level];
    }
    if (count($users))
    {
      $lvl = intval($lvltot/count($users));
    }

    $ep = $lvl*12+36;

    $find_array = array();
    $l1 = 0;
    foreach ($item_base as $name => $data) { // check item level requirements
      if (lvl_req($data[0],100) <= $ep/2 && $name != "talisman" && $name != "fist"&& $name != "body" && $data[1] < 9) $find_array[$l1++] = $name;
    }
    $finditem = $find_array[rand(0,count($find_array)-1)];

    $rand_tali = rand(0,3);
    $prefix="";
    $suffix="";
    if ($rand_tali == 1 || $rand_tali == 3)
    {
      $max_lvl=intval($lvl/3+2);
      if ($max_lvl > 16) $max_lvl = 16;    
      $prefix = $tali_list[rand(0,$max_lvl)][rand(0,2)];
    }
    if ($rand_tali == 2 || $rand_tali == 3)
    {
      $max_lvl=intval($lvl/3+2);
      if ($max_lvl > 16) $max_lvl = 16;    
      $suffix = $tali_list[rand(0,$max_lvl)][rand(3,5)];
    }
    if ($rand_tali == 0 || $rand_tali == 2)
    {
      if (intval(rand(0,1))) $prefix = "*";
      else $prefix = "";
    }
    if ($rand_tali == 0 || $rand_tali == 1)
    {
      if (intval(rand(0,1))) $suffix = "*";
      else $suffix = "";
    }     
    if ($item_base[$finditem][1] == 8)
    {
      $prefix='';
      $suffix='';
    }
    
    $goals[1]= array($finditem,$prefix,$suffix);
    $goals[2] = $loc;
    
    $reward[0] = "G";
    $value = item_val(itp($item_base[$finditem][0]." ".$item_ix[$prefix]." ".$item_ix[$suffix],$item_base[$finditem][1]));
    $reward[1] = intval($value*$goals[0]*1.2);
  
    $qname = "Troubles around ".$loc.": ".ucwords($finditem)." Wanted";
    
  }
  else if ($type == 1)
  {
    $mult = intval(rand(1,5));
    $goals[0] = $mult*5;
    
    $enum = intval(rand(0,100));
    if ($enum < 35) { $eid = 0; }
    elseif ($enum < 60) { $eid = 1; }
    elseif ($enum < 75) { $eid = 2; }
    elseif ($enum < 90) { $eid = 3; }
    else { $eid = 4; }
    
    $goals[1] = $eid;
    
    $filename=$_SERVER['DOCUMENT_ROOT']."/".$subfile."/map/mapdata/".str_replace(' ','_',strtolower($loc)).".map";
    include($filename);
    $mapdata=explode('#',$mapdata);
    $dimensions=explode('|',$mapdata[0]);   
    for ($x=0; $x<7; $x++) $surrounding_area[$x]=str_replace('_',' ',$dimensions[$x+2]);
    $goals[2] = $surrounding_area[intval(rand(0,3))];
    
    $reward[0] = "LI";
    $rtype = rand(0,9);
    if ($rtype == 9) $rtype = 12;
    $reward[1]= $rtype;
    $reward[2] = intval((($eid+$mult)*10)+25);
       
    $qname = "Troubles around ".$loc.": Attacks in ".$goals[2]; 
  }
  
  $quest[name]=$qname;
  $quest[type]=$type;
  $quest[location]= $loc;
  $quest[offerer] = "townsfolk";
  $quest[num_avail]= $num_avail;
  $quest[started]= $started;
  $quest[expire]=$expire;
  $quest[goals]=serialize($goals);
  $quest[reward]=serialize($reward);
  $quest[reqs]=0;
  
  return serialize($quest);
}

function getShopUpLvls ($score, $spec)
{
  for ($type = 0; $type<9; ++$type)
  {
    if ($score >5000) $maxlvl[$type]=12;
    elseif ($score >4500) $maxlvl[$type]=11;
    elseif ($score >4000) $maxlvl[$type]=10;
    elseif ($score >3500) $maxlvl[$type]=9;
    elseif ($score >3000) $maxlvl[$type]=8;
    elseif ($score >2500) $maxlvl[$type]=7;
    elseif ($score >2000) $maxlvl[$type]=6;
    elseif ($score >1500) $maxlvl[$type]=5;
    elseif ($score >500) $maxlvl[$type]=4;
    elseif ($score >500) $maxlvl[$type]=3;
    else $maxlvl[$type]=2; 
  }
  ++$maxlvl[$spec];
  
  return serialize($maxlvl);
}

function weaveStats ($string, $sex, $lvl)
{
  $stats = cparse($string,0);
  $newstats = "A0 B0";
  
  $points = $lvl*12+36;
  $sup = 0;
  if ($stats['sU']) $sup = $stats['sU'];
  
  if ($sex==0)
    $percent = $stats['mA'];
  else
    $percent = $stats['fA'];
  
  $points = floor($points*$percent/100);
  
  if ($stats['sO']) $newstats .= " O".(floor($lvl/$stats['sO'])+$sup);
  if ($stats['sN']) $newstats .= " N".(floor($lvl/$stats['sN'])+$sup);
  if ($stats['sY']) $newstats .= " Y".(floor($lvl/$stats['sY'])+$sup);
  if ($stats['sV']) $newstats .= " V".(floor($lvl/$stats['sV'])+$sup);
  if ($stats['sG']) $newstats .= " G".(floor($lvl/$stats['sG'])+$sup);
  if ($stats['sS']) $newstats .= " S".(floor($lvl/$stats['sS'])+$sup);
  if ($stats['sx']) $newstats .= " X".(floor($lvl/$stats['sX'])+$sup);
  
  $base = 1;
  $do = 1;
  $odd = 0;
  $diff = floor($lvl/$stats['sB'])+1;
  while ($do)
  {
    $tstats = "A".$base." B".($base+$diff+$odd)." ".$newstats;

    if (lvl_req($tstats,100) > $points)
    {
      if (!$odd) {$base--; $odd=1;}
      else $odd = 0;
      $do=0;
    }
    else 
    {
      if ($odd) {$base++; $odd=0;}
      else $odd=1;
    }
  }

  $final = "A".$base." B".($base+$diff+$odd)." ".$newstats;
  
  return $final;
}

function stringWrapper ($str)
{
  $word = explode(" ",$str);
  $line = 0;
  $newstr[$line] = $word[0]." ";
  for ($i = 1; $i < count($word); $i++)
  {
    if (strlen($newstr[$line])+$word[$i] > 39)
      $line++;
    $newstr[$line] = $newstr[$line].$word[$i]." ";
  }
  for ($i = 0; $i < $line; $i++)
  {
    $finalstr .= $newstr[$i]."<br>";
  }
  
  return $finalstr;
}